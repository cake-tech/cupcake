name: build cupcake
run-name: Build cupcake for supported targets
on: [push]

jobs:
    moneroc_android:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                fetch-depth: 0
                submodules: recursive
            - name: clone monero_c
              run: |
                source .env
                git clone https://github.com/mrcyjanek/monero_c
                cd monero_c
                git checkout ${MONERO_C_TAG}
                git submodule update --init --force --recursive
                git config --global --add safe.directory '*'
                git config --global user.email "ci@mrcyjanek.net"
                git config --global user.name "CI mrcyjanek.net"
                ./apply_patches.sh monero
            - name: Free Disk Space
              if: ${{ !startsWith(github.ref, 'refs/tags/v') }}
              uses: jlumbroso/free-disk-space@main
              with:
                tool-cache: false
                android: true
                dotnet: true
                haskell: true
                large-packages: true
                docker-images: true
                swap-storage: true
            - name: Install dependencies
              run: |
                sudo apt update
                sudo apt install -y build-essential pkg-config autoconf libtool ccache make cmake gcc g++ git curl lbzip2 libtinfo5 gperf unzip python-is-python3
            - name: setup ccache
              uses: hendrikmuhs/ccache-action@v1.2
              with:
                key: android-${{ github.job }}-monero
            - name: Cache built depends
              if: ${{ !startsWith(github.ref, 'refs/tags/v') }}
              uses: actions/cache@v4
              with:
                path: |
                  monero_c/monero/contrib/depends/built/*
                key: depends-${{ github.job }}-monero-${{ hashFiles('*monero_c/monero/contrib/depends/packages/*.mk') }}
            - name: monero/x86_64-linux-android
              run: ./build_single.sh monero x86_64-linux-android -j$(nproc)
            - name: monero/aarch64-linux-android
              run: ./build_single.sh monero aarch64-linux-android -j$(nproc)
            - name: monero/armv7a-linux-androideabi
              run: ./build_single.sh monero armv7a-linux-androideabi -j$(nproc)
            - name: Upload lib
              uses: actions/upload-artifact@v4
              with:
                name: android monero
                path: release/monero
            - name: remove android_ndk
              run: |
                rm -rf monero_c/monero/contrib/depends/built/*/android_ndk
                rm -rf monero_c/monero/contrib/depends/sources/android-ndk-r26d-linux.zip
    app_android:
        needs: [moneroc_android]
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                fetch-depth: 0
                submodules: recursive
            - uses: actions/download-artifact@v4
              with:
                name: android monero
                path: .cache/monero_c/gh_actions/release/monero
            - name: use locally cached build from previous step
              run: |
                sed -i 's/^MONERO_C_TAG=.*/MONERO_C_TAG=gh_actions/' .env
            - uses: kuhnroyal/flutter-fvm-config-action@v2
              id: fvm-config-action
            - uses: subosito/flutter-action@v2
              with:
                flutter-version: ${{ steps.fvm-config-action.outputs.FLUTTER_VERSION }}
                channel: ${{ steps.fvm-config-action.outputs.FLUTTER_CHANNEL }}
            - uses: actions/setup-java@v4
              with:
                distribution: 'zulu'
                java-version: '17'
            - name: Flutter pub get
              run: |
                flutter pub get
            - name: Build monero_c
              run: |
                make libs_android_build
            - name: Build apk
              run: |
                flutter build apk